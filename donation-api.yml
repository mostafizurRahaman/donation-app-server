openapi: 3.0.3
info:
  title: Donation API
  description: API for managing donations, payment processing, and donation records
  version: 1.0.0
  contact:
    name: API Support
    email: api-support@crecent-change.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:5000/api/v1/donation
    description: Development server
  - url: https://api.crecent-change.com/api/v1/donation
    description: Production server

tags:
  - name: Donation Management
    description: Operations for managing donations and payments

paths:
  /one-time:
    post:
      tags:
        - Donation Management
      summary: Create one-time donation with payment
      description: Creates a donation record and processes payment in a single operation
      operationId: createOneTimeDonation
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOneTimeDonationRequest'
            examples:
              basic:
                summary: Basic donation
                value:
                  amount: 50.00
                  organizationId: "64f1b2c3d4e5f6789012345"
              withCause:
                summary: Donation with specific cause
                value:
                  amount: 100.00
                  organizationId: "64f1b2c3d4e5f6789012345"
                  causeId: "64f1b2c3d4e5f6789012346"
                  specialMessage: "Keep up the great work!"
      responses:
        '201':
          description: Donation created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateOneTimeDonationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /one-time/without-payment:
    post:
      tags:
        - Donation Management
      summary: Create donation record without payment
      description: Creates a donation record that can be paid for later. Supports idempotency.
      operationId: createDonationRecord
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDonationRecordRequest'
      responses:
        '201':
          description: Donation record created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateDonationRecordResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /{donationId}/payment:
    post:
      tags:
        - Donation Management
      summary: Process payment for existing donation
      description: Creates a payment session for an existing donation record
      operationId: processPaymentForDonation
      security:
        - bearerAuth: []
      parameters:
        - name: donationId
          in: path
          required: true
          schema:
            type: string
          description: ID of the donation to process payment for
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProcessPaymentRequest'
      responses:
        '200':
          description: Payment session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProcessPaymentResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /{donationId}/retry:
    post:
      tags:
        - Donation Management
      summary: Retry failed payment
      description: Creates a new payment session for a failed donation
      operationId: retryFailedPayment
      security:
        - bearerAuth: []
      parameters:
        - name: donationId
          in: path
          required: true
          schema:
            type: string
          description: ID of the donation with failed payment
      responses:
        '200':
          description: Payment retry session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProcessPaymentResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /{id}/status:
    get:
      tags:
        - Donation Management
      summary: Get donation full status with payment info
      description: Retrieves detailed donation status including payment information
      operationId: getDonationFullStatus
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: ID of the donation
      responses:
        '200':
          description: Donation status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DonationFullStatusResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /user:
    get:
      tags:
        - Donation Management
      summary: Get user donations with pagination and filters
      description: Retrieves donations for the authenticated user with filtering options
      operationId: getUserDonations
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: Number of items per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
        - name: status
          in: query
          description: Filter by donation status
          schema:
            type: string
            enum: [all, pending, completed, failed, refunded]
            default: all
        - name: donationType
          in: query
          description: Filter by donation type
          schema:
            type: string
            enum: [all, one-time, recurring, round-up]
            default: all
      responses:
        '200':
          description: Donations retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDonationsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /{id}:
    get:
      tags:
        - Donation Management
      summary: Get specific donation by ID
      description: Retrieves a specific donation that belongs to the authenticated user
      operationId: getDonationById
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: ID of the donation
      responses:
        '200':
          description: Donation retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DonationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /organization/{organizationId}:
    get:
      tags:
        - Donation Management
      summary: Get donations by organization ID
      description: Retrieves donations for a specific organization (requires appropriate permissions)
      operationId: getOrganizationDonations
      security:
        - bearerAuth: []
      parameters:
        - name: organizationId
          in: path
          required: true
          schema:
            type: string
          description: ID of the organization
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: Number of items per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
        - name: status
          in: query
          description: Filter by donation status
          schema:
            type: string
            enum: [all, pending, completed, failed, refunded]
            default: all
        - name: type
          in: query
          description: Filter by donation type
          schema:
            type: string
            enum: [all, one-time, recurring, round-up]
            default: all
      responses:
        '200':
          description: Organization donations retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationDonationsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # Request Schemas
    CreateOneTimeDonationRequest:
      type: object
      required:
        - amount
        - organizationId
      properties:
        amount:
          type: number
          format: float
          minimum: 0.01
          maximum: 99999.99
          description: Donation amount in USD
          example: 50.00
        organizationId:
          type: string
          description: ID of the organization receiving the donation
          example: "64f1b2c3d4e5f6789012345"
        causeId:
          type: string
          description: Optional ID of a specific cause to donate to
          example: "64f1b2c3d4e5f6789012346"
        connectedAccountId:
          type: string
          description: Optional Stripe connected account ID
          example: "acct_1Kx..."
        specialMessage:
          type: string
          maxLength: 500
          description: Optional message to send with the donation
          example: "Keep up the great work!"

    CreateDonationRecordRequest:
      type: object
      required:
        - amount
        - organizationId
      properties:
        amount:
          type: number
          format: float
          minimum: 0.01
          maximum: 99999.99
          description: Donation amount in USD
          example: 50.00
        organizationId:
          type: string
          description: ID of the organization receiving the donation
          example: "64f1b2c3d4e5f6789012345"
        causeId:
          type: string
          description: Optional ID of a specific cause to donate to
          example: "64f1b2c3d4e5f6789012346"
        connectedAccountId:
          type: string
          description: Optional Stripe connected account ID
          example: "acct_1Kx..."
        specialMessage:
          type: string
          maxLength: 500
          description: Optional message to send with the donation
          example: "Keep up the great work!"
        donationId:
          type: string
          description: Optional donation ID for idempotency
          example: "64f1b2c3d4e5f6789012347"

    ProcessPaymentRequest:
      type: object
      properties:
        successUrl:
          type: string
          format: uri
          description: URL to redirect to after successful payment
          example: "https://yourapp.com/payment/success"
        cancelUrl:
          type: string
          format: uri
          description: URL to redirect to after cancelled payment
          example: "https://yourapp.com/payment/cancel"
        paymentMethodType:
          type: string
          enum: [card, ideal, sepa_debit]
          description: Preferred payment method type
          example: "card"

    # Response Schemas
    BaseResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
        data:
          type: object
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    PaginationMeta:
      type: object
      properties:
        limit:
          type: integer
          description: Number of items per page
        page:
          type: integer
          description: Current page number
        total:
          type: integer
          description: Total number of items
        totalPage:
          type: integer
          description: Total number of pages

    Donation:
      type: object
      properties:
        _id:
          type: string
          example: "64f1b2c3d4e5f6789012345"
        donor:
          $ref: '#/components/schemas/UserInfo'
        organization:
          $ref: '#/components/schemas/OrganizationInfo'
        cause:
          $ref: '#/components/schemas/CauseInfo'
        donationType:
          type: string
          enum: [one-time, recurring, round-up]
          example: "one-time"
        amount:
          type: number
          format: float
          example: 50.00
        currency:
          type: string
          example: "USD"
        status:
          type: string
          enum: [pending, completed, failed, refunded]
          example: "pending"
        specialMessage:
          type: string
          example: "Keep up the great work!"
        pointsEarned:
          type: integer
          example: 5000
        stripeSessionId:
          type: string
          example: "cs_test_..."
        stripePaymentIntentId:
          type: string
          example: "pi_..."
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    DonationResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Donation retrieved successfully"
        data:
          $ref: '#/components/schemas/Donation'

    DonationFullStatusResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Donation status retrieved successfully"
        data:
          type: object
          properties:
            donation:
              $ref: '#/components/schemas/Donation'
            paymentInfo:
              type: object
              properties:
                sessionId:
                  type: string
                  example: "cs_test_..."
                paymentUrl:
                  type: string
                  format: uri
                  example: "https://checkout.stripe.com/pay/..."
                paymentStatus:
                  type: string
                  example: "pending"
                failureReason:
                  type: string
                  example: "Payment was cancelled"

    CreateOneTimeDonationResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Donation created successfully"
        data:
          type: object
          properties:
            donation:
              $ref: '#/components/schemas/Donation'
            session:
              type: object
              properties:
                sessionId:
                  type: string
                  example: "cs_test_..."
                url:
                  type: string
                  format: uri
                  example: "https://checkout.stripe.com/pay/..."

    CreateDonationRecordResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Donation record created successfully"
        data:
          type: object
          properties:
            donation:
              $ref: '#/components/schemas/Donation'
            isIdempotent:
              type: boolean
              description: Whether this was an idempotent request (duplicate)
              example: false

    ProcessPaymentResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Payment session created successfully"
        data:
          type: object
          properties:
            sessionId:
              type: string
              example: "cs_test_..."
            url:
              type: string
              format: uri
              example: "https://checkout.stripe.com/pay/..."

    UserDonationsResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Donations retrieved successfully"
        data:
          type: object
          properties:
            donations:
              type: array
              items:
                $ref: '#/components/schemas/Donation'
            total:
              type: integer
              example: 25
            page:
              type: integer
              example: 1
            totalPages:
              type: integer
              example: 3

    OrganizationDonationsResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Organization donations retrieved successfully"
        data:
          type: object
          properties:
            donations:
              type: array
              items:
                $ref: '#/components/schemas/Donation'
            total:
              type: integer
              example: 100
            page:
              type: integer
              example: 1
            totalPages:
              type: integer
              example: 10

    # Reference Schemas
    UserInfo:
      type: object
      properties:
        _id:
          type: string
          example: "64f1b2c3d4e5f6789012348"
        name:
          type: string
          example: "John Doe"
        email:
          type: string
          format: email
          example: "john.doe@example.com"

    OrganizationInfo:
      type: object
      properties:
        _id:
          type: string
          example: "64f1b2c3d4e5f6789012345"
        name:
          type: string
          example: "Save the Ocean Foundation"

    CauseInfo:
      type: object
      properties:
        _id:
          type: string
          example: "64f1b2c3d4e5f6789012346"
        name:
          type: string
          example: "Ocean Cleanup Initiative"
        description:
          type: string
          example: "Supporting ocean conservation efforts"

    # Error Schemas
    ErrorDetail:
      type: object
      properties:
        field:
          type: string
        message:
          type: string

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
        data:
          type: null
          example: null
        errors:
          type: array
          items:
            $ref: '#/components/schemas/ErrorDetail'

  responses:
    BadRequest:
      description: Bad request due to validation errors or invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            validationError:
              summary: Validation error
              value:
                success: false
                message: "Validation failed"
                data: null
                errors:
                  - field: "amount"
                    message: "Amount must be at least 0.01!"

    Unauthorized:
      description: Authentication required or invalid credentials
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "User not authenticated"
            data: null
            errors: []

    Forbidden:
      description: User doesn't have permission to perform this action
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "Access denied"
            data: null
            errors: []

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "Donation not found!"
            data: null
            errors: []

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "Internal server error"
            data: null
            errors: []
